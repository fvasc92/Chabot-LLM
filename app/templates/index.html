<!DOCTYPE html>
<html lang="pt-pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot IPBRICK</title>
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <div class="chat-container">
    <div class="chat-window" id="chatWindow">
      <!-- Mensagens serão exibidas aqui -->
    </div>
    <div class="chat-input">
      <input type="text" id="userInput" placeholder="Mensagem" />
      <button id="sendButton">></button>
    </div>
  </div>

    <script>
    const chatWindow = document.getElementById('chatWindow');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');

    let isProcessing = false;

    sendButton.addEventListener('click', () => {
        const userMessage = userInput.value.trim();
        if (userMessage && !isProcessing) {
            sendMessage(userMessage);
        }
    });

    userInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !isProcessing) {
            event.preventDefault();
            const userMessage = userInput.value.trim();
            if (userMessage) {
                sendMessage(userMessage);
            }
        }
    });

    function sendMessage(userMessage) {
        displayMessage(userMessage, 'user');
        userInput.value = '';
        toggleSendButton(false);
        isProcessing = true;

        // Cria um placeholder para a mensagem do bot
        const botPlaceholder = displayMessage('', 'bot');

        // Configura a conexão de streaming
        const eventSource = new EventSource(`/ask?message=${encodeURIComponent(userMessage)}`);

        eventSource.onmessage = (event) => {
            const chunk = event.data;
            if (chunk) {
                const formattedChunk = formatText(chunk);
                botPlaceholder.innerHTML += formattedChunk;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        };

        eventSource.onerror = () => {
            eventSource.close();
            toggleSendButton(true);
            isProcessing = false;
        };

        eventSource.onclose = () => {
            toggleSendButton(true);
            isProcessing = false;
        };
    }

    function displayMessage(message, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        if (sender === 'bot') {
            messageElement.innerHTML = message; // Usado para chunks
        } else {
            messageElement.textContent = message;
        }
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return messageElement; // Retorna o elemento para atualização futura
    }

    // Função para formatar o texto em frases legíveis
    function formatText(text) {
        // Substitui espaços múltiplos por um único espaço
        let formatted = text.replace(/\s+/g, ' ');

        // Adiciona quebras de linha após cada ponto final e faz a formatação de parágrafos
        formatted = formatted.replace(/([.!?])\s*(?=\S)/g, '$1<br><br>');

        return formatted;
    }

    function updateBotMessage(newChunk) {
        const botMessages = chatWindow.querySelectorAll('.message.bot');
        const lastBotMessage = botMessages[botMessages.length - 1];
        if (lastBotMessage) {
            lastBotMessage.innerHTML += newChunk;
        } else {
            displayMessage(newChunk, 'bot');
        }
    }

    function toggleSendButton(isEnabled) {
        sendButton.disabled = !isEnabled;
        sendButton.style.cursor = isEnabled ? 'pointer' : 'not-allowed';
    }

    userInput.addEventListener('input', () => {
        if (userInput.value.trim()) {
            sendButton.classList.add('active');
        } else {
            sendButton.classList.remove('active');
        }
    });
  </script>

</body>
</html>

